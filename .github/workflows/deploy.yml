name: Deploy to VM

on:
  push:
    branches: [main]
    paths:
      - 'vm_server/**'
      - 'vm/deploy.sh'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      restart_only:
        description: 'Restart only (skip rsync and dependency sync)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug SSH Key
        run: |
          echo "Key starts with: $(echo "${{ secrets.VMSSHPRIVATE_KEY }}" | head -c 20)"
          echo "VM_HOST: ${{ secrets.VM_HOST }}"
          echo "VM_USER: ${{ secrets.VM_USER }}"

      - name: Setup SSH
        run: |
          echo "ğŸ” Setting up SSH connection..."
          mkdir -p ~/.ssh
          echo "${{ secrets.VMSSHPRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add VM host to known_hosts
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
          
          # Test SSH connection
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "echo 'âœ… SSH connection successful'"

      - name: Debug Rsync Variables
        if: ${{ !inputs.restart_only }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” DEBUGGING RSYNC CONFIGURATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "VM_USER is set: ${{ secrets.VM_USER != '' }}"
          echo "VM_HOST is set: ${{ secrets.VM_HOST != '' }}"
          echo "VMDEST_DIR is set: ${{ secrets.VMDEST_DIR != '' }}"
          echo ""
          echo "VM_USER length: $(echo -n '${{ secrets.VM_USER }}' | wc -c) characters"
          echo "VM_HOST length: $(echo -n '${{ secrets.VM_HOST }}' | wc -c) characters"
          echo "VMDEST_DIR length: $(echo -n '${{ secrets.VMDEST_DIR }}' | wc -c) characters"
          echo ""
          echo "Full rsync target path will be:"
          echo "${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:${{ secrets.VMDEST_DIR }}/"
          echo ""
          echo "VMDEST_DIR starts with: $(echo '${{ secrets.VMDEST_DIR }}' | cut -c1-10)..."
          echo "VMDEST_DIR ends with: ...$(echo '${{ secrets.VMDEST_DIR }}' | tail -c 10)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify remote directory
        if: ${{ !inputs.restart_only }}
        run: |
          echo "ğŸ” Verifying remote directory structure..."
          
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "echo 'Current user: \$(whoami)'; \
             echo 'Home directory: \$HOME'; \
             echo 'Target directory: ${{ secrets.VMDEST_DIR }}'; \
             echo ''; \
             echo 'Checking if directory exists:'; \
             if [ -d '${{ secrets.VMDEST_DIR }}' ]; then \
               echo 'âœ… Directory exists'; \
               ls -la '${{ secrets.VMDEST_DIR }}' | head -n 10; \
               echo ''; \
               echo 'Directory permissions:'; \
               stat -c '%A %U:%G' '${{ secrets.VMDEST_DIR }}'; \
             else \
               echo 'âŒ Directory does NOT exist'; \
               echo 'Attempting to create it...'; \
               mkdir -p '${{ secrets.VMDEST_DIR }}' && echo 'âœ… Directory created' || echo 'âŒ Failed to create directory'; \
             fi"

      - name: Sync code to VM
        if: ${{ !inputs.restart_only }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Starting rsync deployment..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Source: vm_server/"
          echo "Target: ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:${{ secrets.VMDEST_DIR }}/"
          echo ""
          
          rsync -avvz --progress \
            --exclude='venv/' \
            --exclude='__pycache__/' \
            --exclude='*.pyc' \
            --exclude='*.bak*' \
            --exclude='*~' \
            --exclude='.env' \
            --exclude='memory/' \
            --exclude='.git/' \
            -e "ssh -i ~/.ssh/deploy_key" \
            vm_server/ ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:${{ secrets.VMDEST_DIR }}/
          
          rsync_exit_code=$?
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ $rsync_exit_code -eq 0 ]; then
            echo "âœ… Rsync completed successfully (exit code: $rsync_exit_code)"
          else
            echo "âŒ Rsync failed with exit code: $rsync_exit_code"
            exit $rsync_exit_code
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Install dependencies
        if: ${{ !inputs.restart_only }}
        run: |
          echo "ğŸ“š Installing Python dependencies..."
          
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "if [ -f '${{ secrets.VMDEST_DIR }}/requirements.txt' ]; then \
              echo 'Found requirements.txt, installing dependencies...'; \
              ${{ secrets.VM_VENV_PY }} -m pip install --upgrade pip && \
              ${{ secrets.VM_VENV_PY }} -m pip install -r '${{ secrets.VMDEST_DIR }}/requirements.txt'; \
              echo 'âœ… Dependencies installed'; \
            else \
              echo 'âš ï¸  No requirements.txt found, skipping dependency installation'; \
            fi"

      - name: Restart service
        run: |
          echo "ğŸ”„ Restarting ${{ secrets.VM_SERVICE }}..."
          
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "sudo systemctl daemon-reload && sudo systemctl restart ${{ secrets.VM_SERVICE }}"
          
          echo "âœ… Service restart command sent"
          echo "â³ Waiting 5 seconds for service to initialize..."
          sleep 5

      - name: Verify service status
        run: |
          echo "ğŸ” Checking service status..."
          
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "sudo systemctl is-active ${{ secrets.VM_SERVICE }} && \
             echo 'âœ… Service is active' || \
             (echo 'âŒ Service is not active' && \
              sudo systemctl status ${{ secrets.VM_SERVICE }} && \
              exit 1)"

      - name: Construct and validate health check URL
        id: health_url
        run: |
          echo "ğŸ” Constructing health check URL from VMMCPURL..."
          BASE_URL="${{ secrets.VMMCPURL }}"
          
          # Check if BASE_URL is empty
          if [ -z "$BASE_URL" ]; then
            echo "âŒ VMMCPURL secret is empty or not set"
            echo "Please configure the VMMCPURL secret in repository settings"
            exit 1
          fi
          
          # Remove trailing slashes
          BASE_URL=$(echo "$BASE_URL" | sed 's:/*$::')
          
          # Check if URL starts with http:// or https://
          if [[ ! "$BASE_URL" =~ ^https?:// ]]; then
            echo "âŒ Invalid URL format: $BASE_URL"
            echo "VMMCPURL must start with http:// or https://"
            exit 1
          fi
          
          # Construct health check URL
          HEALTH_URL="${BASE_URL}/health"
          
          echo "âœ… Base URL (VMMCPURL): $BASE_URL"
          echo "âœ… Health check URL: $HEALTH_URL"
          echo ""
          
          # Export for next step
          echo "HEALTH_URL=$HEALTH_URL" >> $GITHUB_OUTPUT

      - name: HTTP health check
        run: |
          echo "ğŸ¥ Running HTTP health check..."
          HEALTH_URL="${{ steps.health_url.outputs.HEALTH_URL }}"
          echo "ğŸ” Health URL: $HEALTH_URL"
          echo ""
          
          max_attempts=10
          attempt=0
          success=false
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts..."
            
            # Use -f to fail on HTTP errors, capture both body and status
            response=$(curl -sS -w "\nHTTP_STATUS:%{http_code}\n" "$HEALTH_URL" 2>&1 || echo "CURL_ERROR:$?" ; echo "HTTP_STATUS:000")
            
            # Check if curl itself failed
            if echo "$response" | grep -q "CURL_ERROR:"; then
              curl_error=$(echo "$response" | grep "CURL_ERROR:" | cut -d: -f2)
              echo "âŒ Curl failed with exit code $curl_error"
              if echo "$response" | grep -q "URL rejected"; then
                echo "âŒ URL is malformed: $HEALTH_URL"
                echo "Please check the VMMCPURL secret configuration"
                echo "Current value (sanitized): ${{ secrets.VMMCPURL }}"
                exit 1
              fi
              if echo "$response" | grep -q "Could not resolve host"; then
                echo "âŒ Cannot resolve hostname in URL"
                echo "Please verify the hostname/IP in VMMCPURL is correct"
              fi
            else
              status=$(echo "$response" | grep "HTTP_STATUS:" | tail -n1 | sed 's/HTTP_STATUS://')
              body=$(echo "$response" | sed '/HTTP_STATUS:/d')
              
              if [[ "$status" == 2* ]]; then
                echo "âœ… HTTP health check successful (HTTP $status)"
                echo "Response: $(echo "$body" | head -n1)"
                success=true
                break
              else
                echo "âš ï¸  Server returned status $status"
                if [ -n "$body" ]; then
                  echo "Response body: $(echo "$body" | head -n3)"
                fi
              fi
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "Retrying in 3 seconds..."
              sleep 3
            fi
          done
          
          if [ "$success" = false ]; then
            echo "âŒ HTTP health check failed after $max_attempts attempts"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Check if the service is running: sudo systemctl status ${{ secrets.VM_SERVICE }}"
            echo "2. Check service logs: sudo journalctl -u ${{ secrets.VM_SERVICE }} -n 50"
            echo "3. Verify the health endpoint is accessible: curl -v $HEALTH_URL"
            echo "4. Check if port is listening: sudo netstat -tlnp | grep :8000"
            echo "5. Verify VMMCPURL is set correctly: ${{ secrets.VMMCPURL }}"
            exit 1
          fi

      - name: Cleanup SSH keys
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up SSH keys..."
          rm -f ~/.ssh/deploy_key
          echo "âœ… Cleanup complete"

      - name: Deployment summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Deployment completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Target: ${{ secrets.VM_HOST }}"
          echo "ğŸ“‚ Directory: ${{ secrets.VMDEST_DIR }}"
          echo "ğŸ”§ Service: ${{ secrets.VM_SERVICE }}"
          echo "ğŸŒ MCP URL: ${{ secrets.VMMCPURL }}"
          echo "ğŸ’š Health URL: ${{ steps.health_url.outputs.HEALTH_URL }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment failure notice
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deployment failed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Please check the logs above for details."
          echo "You may need to manually investigate the VM."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
